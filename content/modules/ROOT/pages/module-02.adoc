== Module 02: Red Hat Advanced Cluster Security for Kubernetes

In this session, participants will learn how to work with Red Hat Advanced Cluster Security for Kubernetes (RHACS).

The goal of the tasks in this part of the OpenShift Platform Plus lab  is to take you through the RHACS console/user interface and to observe network traffic maps to get you used to finding vulnerabilities in your clusters. After you are comfortable with the general look and feel of RHACS, we will create and apply some custom policies to affect pods at both deployment and runtime. 

If you have questions at any time, please don’t hesitate to ask!

=== RHACS Basics

RHACS provides the tools and capabilities to address the security needs of a cloud-native development approach on Kubernetes.

The RHACS solution offers visibility into the security of your cluster, vulnerability management, and security compliance through auditing, network segmentation awareness and configuration, security risk profiling, security-related configuration management, threat detection, and incident response. In addition, RHACS grants an ability to pull the actions from that tooling deep into the application code development process through APIs.

These security features represent any developer or administrator’s primary work across various environments, including multiple datacenters, private clouds, or public clouds that run Kubernetes clusters.

=== RHACS Features

Using Red Hat Advanced Cluster Security for Kubernetes, you can gain comprehensive Kubernetes security that includes the following use cases:

- *Visibility:* See your entire landscape of images, registries, containers, deployments, and runtime behavior.
- *Vulnerability* Management: Identify and remediate vulnerabilities in container images and Kubernetes across the entire software development life cycle.
- *Compliance:* Audit your systems against CIS Benchmarks, NIST, PCI, and HIPAA, with interactive dashboards and one-click audit reports.
- *Network Segmentation:* Visualize existing connections and enforce tighter segmentation using Kubernetes-native controls to reduce your blast radius.
- *Risk Profiling:* See all your deployments ranked by risk level, using context from Kubernetes' declarative data, to prioritize remediation.
- *Configuration Management:* Apply best practices for Docker and Kubernetes to harden your environment for a more secure and stable application.
- *Threat Detection:* Use rules, automated allow lists, and baselining to accurately identify suspicious activity in your running applications.
- *Incident Response:* Take action, from failing builds and blocking deployments to killing pods and thwarting attacks, using Kubernetes for enforcement.

[[lab-setup]]

== Lab Setup

To have the applications and vulnerabilities necessary for the demo, we need to introduce a few vulnerable applications into the cluster.

NOTE: This step is mandatory, you must deploy these applications into your cluster in order to work through the lab exercises.

The command below will clone the tutorial sources and set the *TUTORIAL_HOME* environment variable to point to the root directory of the tutorial and deploy the applications.

Please complete the following steps to configure your lab environment

- Click the button to run the command in the terminal.

[source,sh,role=execute]
----
git clone https://github.com/openshiftdemos/openshift-ops-workshops acs-workshop
export TUTORIAL_HOME="$(pwd)/acs-workshop"
kubectl apply -f $TUTORIAL_HOME/workshop/demo-apps/configuration --recursive
kubectl apply -f $TUTORIAL_HOME/workshop/demo-apps/ --recursive
----

CAUTION: These commands download and apply a significant number of manifests to your environment. All of these applications are insecure, and pose a significant threat if used elsewhere. Please use these commands with caution.

- To ensure the deployment was successful, run the following command and ensure that the applications are up and running.


[source,sh,role=execute]
----
kubectl get deployments -l demo=acs -A
----

The output should look similar to this:

[source,texinfo,subs="attributes"]
----
NAMESPACE      NAME               READY   UP-TO-DATE   AVAILABLE   AGE
backend        api-server         1/1     1            1           0d
frontend       asset-cache        1/1     1            1           0d
log4shell      log4shell-app      3/3     3            3           0d
medical        reporting          1/1     1            1           0d
operations     jump-host          1/1     1            1           0d
payments       visa-processor     1/1     1            1           0d
spring4shell   spring4shell-app   3/3     3            3           0d
----

If all of the applications are up and running, feel free to proceed to the next stage. If they are not running, rerun the command set, or ask a proctor for assistance.

[[con-vuln]]

== Introducing the RHACS console and Vulnerability Management

The first section of this lab will focus on navigation and vulnerability management. This work will take place in the UI and require you to use both the dashboard and the lab environment.

=== Accessing the RHACS Console

In this section, you will confirm that you can connect to the RHACS portal. 

The following information will be available in the the main lab screen:

- The RHACS admin Credentials
- The URL for the RHACS portal

=== Logging into the RHACS Console

- From the main lab page, click the URL for the RHACS web console to head to the console's login page.

image::201-lab-environment.png[Lab Environment]

NOTE: You may get a warning page that the webpage is not private. During setup, RHACS can utilize your certification server to avoid these errors. It is also considered best practice to integrate the application with your authentication server.

- Click through the warning page to get to the RHACS console login page.

image::202-cert-warning.png[Certificate Warning]

image::203-login-page.png[Login Page]

- Log in with the ADMINISTRATOR credentials from the main demo page. These credentials are located with all of the demo credentials and will be underneath the RHACS console URL *(HINT: The Username is always admin)*.

image::204-admin-login.png[Admin Login]

- Ensure you maintain access to the console and keep your tab open for the future lab sections.

image::205-rhacs-dashboard.png[RHACS Dashboard]

[[nav-con]]

== Navigating the RHACS Console

In this section, you familiarize yourself with the RHACS portal, including its tabs, search capabilities and dashboard functionality.

The RHACS dashboard has four main sections:

. Top Bar
. Global Search
. Navigation Menu
. Dashboard

image::206-numbered-dashboard.png[Numbered Dashboard]

=== Top Bar

The top bar contains the following functionality: 

- Global Search 
- Command-line tools 
- Cluster Health 
- Documentation 
- API Reference 
- Enable Dark/Light Mode 
- Logged-in user account

image::207-top-bar.png[Top Bar]

=== Global Search

The ability to instantly find resources is essential to safeguard your cluster. Utilize the RHACS search feature to find relevant resources faster.

For example, you can use it to find deployments exposed to a newly published CVE or all deployments with external network exposure.

A search query consists of two parts:

- An attribute that identifies the resource type you want to search for.
- A search term that finds the matching resource.

For example, to find all violations in the *visa-processor* deployment, the search query is *Deployment:visa-processor*.

image::209-search-syntax.png[Search Syntax]

In this search query, Deployment is the attribute, and visa-processor is the search term.

NOTE: When using the search functionality you must click the provided info from the dropdown. RHACS maintains a library of searchable assets to help you search faster. If CVE or deployment cannot be searched it is most likely because the resource is not in the cluster or incorrectly typed.


=== Local Page Filtering

You can use local page filtering from within all views in the RHACS portal. Local page filtering works similarly to the global search, but only relevant attributes are available. You can select the search bar to show all available attributes for a specific view.

=== Common Search Queries

Here are some common search queries you can try in the RHACS search bar if you’d like to test its functionality.

|============
|Query|Example|Purpose
|CVE:<CVE_number>|CVE:CVE-2018-11776|Finding deployments that are affected by a specific CVE
|Privileged:<true_or_false>|Privileged:true|Finding privileged running deployments
|Exposure Level:<level>|Exposure Level:External|Finding deployments that have external network exposure
|============

NOTE: This is just a sample of the types of queries you can use to analyze your environment in RHACS. For additional examples of search queries, please see the RHACS documentation.

=== Navigation Menu

image::210-nav-menu.png[Navigation Menu]

The left-hand navigation menu provides access to each of the security use cases, as well as product configuration to integrate RHACS with your existing tooling. The navigation menu has the following items:

- Dashboard: Summary view of your environment
- Network Graph: Configured and actual network flows and the creation of Network Policies to implement network segmentation
- Violations: Events that do not match the defined security policies
- Compliance: Several industry and regulatory security standards, such as PCI DSS
- Vulnerability Management: Information about known vulnerabilities affecting your environment, including deployed workloads and infrastructure, risk acceptance and reporting.
- Configuration Management: Identification of potential misconfigurations that can lead to security issues
- Risk: Risks affecting your environment, such as suspicious executions
- Platform Configuration: RHACS configuration, policy management and integration details, including;
* Clusters
* Policy Management
* Integrations
* Access Control
* System Configuration
* System Health

=== Dashboard 

The Red Hat Advanced Cluster Security for Kubernetes (RHACS) Dashboard provides quick access to the data you need. It contains additional navigation shortcuts and actionable widgets that are easy to filter and customize so that you can focus on the data that matters most to you. You can view information about levels of risk in your environment, compliance status, policy violations, and common vulnerabilities and exposures (CVEs) in images.

image::211-dashboard-center.png[Center Dashboard]

=== Navigating the Main Dashboard

The main Dashboard is your place to look at the vulnerabilities, risk, compliance, and policy violations across your clusters and namespaces. This section addresses all of the functionality in the main Dashboard to help you navigate it more effectively in the future.

The dashboard can be broken down into three main sections:

. The Status Bar
. The Dashboard Filter
. The Actionable Widgets

image::212-three-dashboards.png[Three Dashboard Sections]

=== The Status Bar

The Status Bar provides at-a-glance numerical counters for critical resources. The counters reflect what is visible with your current access scope, defined by the roles associated with your user profile. 

These counters are clickable, providing fast access to the desired list view pages as follows:

|============
|Counter|Destination
|Clusters|Platform Configuration -> Clusters
|Nodes|Configuration Management -> Applications & Infrastructure -> Nodes
|Violations|Violations Main Menu
|Deployments|Configuration Management -> Applications & Infrastructure -> Deployments
|Images|Vulnerability Management -> Dashboard -> Images
|Secrets|Configuration Management -> Applications & Infrastructure -> Secrets
|============

=== The Dashboard Filter 

The Dashboard includes a top-level filter that applies simultaneously to all widgets. You can select clusters and one or more namespaces within selected clusters. Any change to the filter is immediately reflected by all widgets, limiting the data they present to the selected scope.

NOTE: The Dashboard filter does not affect the Status Bar and when no clusters or namespaces are selected, the view automatically switches to All.

image::213-dashboard-filter.png[Dashboard Filter]

image::214-dashboard-dropdown.png[Dashboard Drop-down]

=== Actionable Widgets

If you have time, adjust the dashboard filtering options and widgets to hone the filtering capabilities.

With these widgets, you can customize the information displayed on the dashboard by default in order to find the items that you consider most important to your deployments and your business' security.

[[vuln-mgmt]]

== The Vulnerability Management Dashboard

Let us continue by looking at our primary use case for RHACS and that is the Vulnerability Management features and dashboard, a familiar topic for most security teams.

IMPORTANT: The locations and size of your panels may vary depending on your screen size and zoom.

NOTE: For the following section, please note that the order in which the images appear or the number of components affected may vary depending on versions and other applications running in the cluster.

. Click the *Vulnerability Management (1.0)* tab, and then select *Dashboard*
+
image::215-vuln-dashboard.png[Vulnerability Management Dashboard]
+
The dashboard provides several important vulnerability breakdowns such as:
+
- Top risky deployments/images
- Recently detected image vulnerabilities
- Most common image vulnerabilities
+
More important than fixing any vulnerability is establishing a process to keep container images updated and to prevent the promotion through the pipeline for images with serious, fixable vulnerabilities. RHACS displays this through the *Top Risky Deployments by CVE and CVSS Score* and takes the container’s configuration and vulnerability details to show you the most *at risk* deployments in your cluster.
+
image::216-top-risky.png[Riskiest Deployments]
+
. Above the *Risky Deployments* section, there are buttons to link you to all policies, CVEs, and images, and a menu to bring you to reports by cluster, namespace, deployment, and component. The vulnerability dashboard can be filtered by clicking the Fixable CVSS score button.
+
image::217-policy-buttons.png[Top Policy Buttons]
+
. Locate the *Top Riskiest Images* panel. Here you can see the CVEs associated with containers currently running in the cluster. The goal is to find the *log4shell* exploit in your cluster and block that container from being pushed in the future.
+
image::218-riskiest-images.png[Riskiest Images]
+
. In the *Top Riskiest Images* panel, click on the *VIEW ALL* button.
+
The images in this dashboard are listed here in order of RISK, based on the number and severity of the vulnerabilities present in the components in the images
+
Notice which images are more exposed. Not only can we see the number of CVEs affecting the images, but which of them are fixable? We can also see:
+
- Creation date
- Scan time
- Image OS
- Image status
- How many deployments are using the vulnerable image
- The total components in the image
+
. Next, find and click on the image *visa-processor:latest-v2*. You will review the images' components and violations.
+
image::219-visa-proc.png[Visa Processor Image]
+
NOTE: If you cannot find the visa-processor:latest-v2 image, use the search bar to filter for the specific image you want.
+
If you click the search bar, you will be shown the different labels you can search by. Click Image and type visa until the correct image comes up.
+
You can use this method of searching in all search bars within the RHACS dashboard.
+
image::220-search-bar.png[Search Bar]
+
You can move on to the next section only when the dashboard displays the image below.
+
image::221-image-info.png[Image Info]


=== RHACS Vulnerability Scanner

RHACS' built-in vulnerability scanner breaks down images into layers and components - where components can be operating-system installed packages or dependencies installed by programming languages like Python, Javascript, or Java. The Image Summary provides the essential security details of the image overall, with links to the components. Below you can see why the image is ranked as a critically vulnerable application:

- In the DETAILS & METADATA → Image OS panel, the information you see there tells you that this image has a severe security problem - the base image was imported several years ago (Debian 8 - 2015).
- At the top of the page is the warning that CVE data is stale - that this image has a base OS version whose distribution has stopped providing security information and likely stopped publishing security fixes.
- Scroll down the page. In the Image Findings section, you find the details of the image vulnerabilities. There are 535 fixable vulnerabilities in the cluster (at the time of the creation of this workshop.)
+
image::222-fix-vulns.png[Fixable Vulnerabilities]
+
- Above the Image Findings section, click on the *Dockerfile* tab:
+
image::223-dockerfile.png[Dockerfile View]
+
The Dockerfile tab view shows the layer-by-layer view, and, as you can see, the most recent layers are also several years old. Time is not kind to images and components - as vulnerabilities are discovered, RHACS will display newly discovered CVEs.

*Now let's put this UI to the test with a real use case!*


=== log4shell CVE Vulnerability Analysis

It is time to find the components that have the log4shell vulnerability in your cluster. Zero day and high priority vulnerabilities need to be triaged quickly. The log4shell vulnerability provides a great example of how security teams can assess a vulnerability's impact quickly and effectively.

Check out the Red Hat advisory for more details:

. Head back to the *Top Riskiest Images* Dashboard. (Vulnerability Management → Top Riskiest Images)
+
image::224-riskiest-images2.png[Riskiest Images]
+
. Search for the log4shell vulnerability using its CVE number (*CVE-2021-44228*)
+
image::225-log4shell-search.png[log4shell Search]
+
- How many images are affected by the vulnerability?
- How many deployments contain the vulnerability?
- Why do you think the risk priority is where it is?
- Should the risk priority be higher? Or lower?

NOTE: The log4shell CVE is very serious - scoring 10/10 - and is fixable.

Luckily there is only *ONE* image being affected by this vulnerability (2 deployments), so you could go directly to the source and fix all three deployments in one opportunity.

*How would your DevSecOps team address this vulnerability?*


=== Relating Image CVEs with Kubernetes Configuration Properties

All of these CVE details are well and good, but they are a bit noisy. How do we judge the genuine risk - which vulnerabilities are likely to be exploited? Which vulnerabilities do we have to fix first? RHACS can use other sources of information in OpenShift to judge the risk that a given vulnerability would be exploited and set priorities for fixes.

The first *risk factor* - is the vulnerable component in a running deployment.

. Click on the *Risk* panel to continue.
+
image::226-risk-panel.png[Risk Panel]
+
Take a look at the total amount of deployments in the cluster. If you remember, the log4shell image was rated a 5 on risk priority based on CVSS score and other CVEs. But at the time this lab is written it now shows as a 12. Why we must ask ourselves, is it down to a priority of 12 in this example now?
+
image::227-log4shell-risk.png[Log4Shell Risk]
+
. Click on the log4shell deployment and review the risk indicators.
+
image::228-log4shell-info.png[Log4Shell Info]
+
. Next, click on the visa-processor deployment and review its risk indicators. What do you think made the visa-processor deployment #1 in this example?
+
image::229-visa-processor.png[Visa Processor Info]
+
Factors that play into the overall score are in the risk indicators section. These include, but are not limited to:
+
- Policy Violations
- Image Vulnerabilities
- Service Configuration
- Service Reachability
- Components Useful for Attackers
- Number of Components in an Image
- Image Freshness
- RBAC Configuration

A primary reason for the visa-processor deployment to be ranked so high is that it is an ancient image (older than the log4shell app). A good indicator of risk is that the older an image is, the more likely it will have a significant exploitable vulnerability.

We will leave it to you to make your own risk assessments in the future. 

Now, let us move along to enforcing a log4shell policy and stopping future deployments containing the vulnerability.

[[policy-mgmt]]

== Policy Management

RHACS has many built-in policies to detect activity related to attacker goals: gain a foothold, maintain a presence, move laterally, and exfiltrate data. The continuous runtime monitoring observes all container activity and will automatically respond to events with appropriate enforcement and notification. However, that would be missing out on an opportunity - RHACS wants to go one step further, to take advantage of containers' ephemeral, immutable nature, to improve security in a measurable way from now on.

We want to use runtime incidents and vulnerabilities as a learning opportunity to improve security going forward by constraining how our containers can act. We achieve this by creating policies and implementing them early in the CI/CD process.

As we move into this next section, lets focus on identifying and enforcing a runtime policy in the cluster. For the upcoming example, we will focus on stopping the Ubuntu package manager from being run on pods in our cluster.

. On the left-hand side of the application, click the *Platform Configuration* tab and select *Policy Management*.
+
image::230-policy-mgmt-dashboard.png[Policy Management Dashboard]
+
. Filter through the policies to find *Ubuntu Package Manager Execution* or use the search bar to select by *category*.
+
image::231-policy-search.png[Policy Management Search]
+
. Once you have found the policy *Ubuntu Package Manager Execution*, click on it to learn more.
+
image::232-policy-mgmt-details.png[Policy Management Details]
+
. If you click the actions button, you will see how easy it is to edit, clone, export or disable these policies. We also recommended cloning the policies and adding or removing specific filters as you need them.

[[network-seg]]

== Introduction to Network Segmentation

